<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Language metadata ---
  var LANG_NAMES = {
    en: 'English', zh: '简体中文',
    ar: 'العربية', bn: 'বাংলা', cs: 'Čeština', de: 'Deutsch',
    el: 'Ελληνικά', es: 'Español', fr: 'Français', he: 'עברית',
    hi: 'हिन्दी', hu: 'Magyar', id: 'Bahasa Indonesia', it: 'Italiano',
    ja: '日本語', ko: '한국어', la: 'Latina', nl: 'Nederlands',
    pl: 'Polski', pt: 'Português', ru: 'Русский', sv: 'Svenska',
    tr: 'Türkçe', uk: 'Українська',
    'zh-Hans': '简体中文 (翻译版)', 'zh-Hant': '繁體中文'
  };

  // Languages that have a full docs section (not just a single translation file)
  var FULL_SECTION_LANGS = ['en', 'zh', 'es', 'fr', 'pt', 'it', 'he'];

  // --- DOM refs ---
  var btn = document.getElementById('lang-switcher-btn');
  var dropdown = document.getElementById('lang-dropdown');
  var currentNameEl = document.getElementById('lang-current-name');
  if (!btn || !dropdown || !currentNameEl) return;

  var items = dropdown.querySelectorAll('li[data-lang]');

  // --- Helpers ---
  var STORAGE_KEY = 'sourcecanon-lang';

  function getSavedLang() {
    try { return localStorage.getItem(STORAGE_KEY); } catch (e) { return null; }
  }

  function saveLang(lang) {
    try { localStorage.setItem(STORAGE_KEY, lang); } catch (e) { /* ignore */ }
  }

  // --- Page classification ---
  function classifyCurrentPage() {
    var path = window.location.pathname.replace(/\/$/, '').replace(/\/index\.html$/, '');
    // Home
    if (path === '' || path === '/index.html') {
      return { type: 'home' };
    }
    // Full-section language pages: /docs/{lang} or /docs/{lang}/slug
    var sectionMatch = path.match(/^\/docs\/(en|zh|es|fr|pt|it|he)(?:\/(.*))?$/);
    if (sectionMatch) {
      return { type: sectionMatch[1], slug: sectionMatch[2] || 'index' };
    }
    // Translation pages: /docs/translations/canon-XX or /docs/translations/rhythms-XX
    var transCanon = path.match(/^\/docs\/translations\/canon-([a-zA-Z-]+?)(?:\.html)?$/);
    if (transCanon) {
      return { type: 'translation', content: 'canon', langCode: transCanon[1] };
    }
    var transRhythms = path.match(/^\/docs\/translations\/rhythms-([a-zA-Z-]+?)(?:\.html)?$/);
    if (transRhythms) {
      return { type: 'translation', content: 'rhythms', langCode: transRhythms[1] };
    }
    // Translations index
    if (path === '/docs/translations') {
      return { type: 'translations-index' };
    }
    // Rhythms
    if (path.match(/^\/docs\/rhythms(?:\.html)?$/)) {
      return { type: 'rhythms' };
    }
    return { type: 'other' };
  }

  // --- Target URL computation ---
  function computeTargetUrl(targetLang) {
    var page = classifyCurrentPage();

    // Home: stay on home
    if (page.type === 'home') return null;

    // Rhythms page: bilingual for EN/ZH; translation file for all others
    if (page.type === 'rhythms') {
      if (targetLang === 'en' || targetLang === 'zh') return null;
      return '/docs/translations/rhythms-' + targetLang + '.html';
    }

    // Full-section language pages: navigate to same slug in target section
    if (FULL_SECTION_LANGS.indexOf(page.type) !== -1) {
      if (targetLang === page.type) return null; // already on this lang
      if (FULL_SECTION_LANGS.indexOf(targetLang) !== -1) {
        // Navigate to same page in another full section
        var slug = page.slug ? page.slug.replace(/\.html$/, '') : 'index';
        if (slug === 'index') return '/docs/' + targetLang + '/';
        return '/docs/' + targetLang + '/' + slug + '.html';
      }
      // Non-full-section lang → single translation file
      return '/docs/translations/canon-' + targetLang + '.html';
    }

    // Translation pages
    if (page.type === 'translation') {
      if (FULL_SECTION_LANGS.indexOf(targetLang) !== -1) {
        return page.content === 'canon' ? '/docs/' + targetLang + '/' : '/docs/rhythms.html';
      }
      return '/docs/translations/' + page.content + '-' + targetLang + '.html';
    }

    // Translations index
    if (page.type === 'translations-index') {
      if (FULL_SECTION_LANGS.indexOf(targetLang) !== -1) return '/docs/' + targetLang + '/';
      return null;
    }

    return null;
  }

  // --- Nav visibility ---
  function updateNavVisibility(lang) {
    var sideNav = document.querySelector('.site-nav, .nav-list');
    if (!sideNav) return;

    // Map nav link text → lang code it belongs to
    var SECTION_NAV_MAP = {
      'Canon (EN)': 'en',
      '正典 (中文)': 'zh',
      '正典（中文）': 'zh',
      'Canon (ES)': 'es',
      'Canon (FR)': 'fr',
      'Canon (PT)': 'pt',
      'Canon (IT)': 'it',
      'קנון (HE)': 'he'
    };

    var navItems = document.querySelectorAll('.nav-list > .nav-list-item');
    navItems.forEach(function (item) {
      var link = item.querySelector('.nav-list-link');
      if (!link) return;
      var text = link.textContent.trim();

      if (SECTION_NAV_MAP.hasOwnProperty(text)) {
        item.style.display = (SECTION_NAV_MAP[text] === lang) ? '' : 'none';
      } else if (text === 'Translations') {
        // Hide translations nav for all languages (translation pages have no sub-nav)
        item.style.display = 'none';
      }
      // "Home" and "Rhythms of Flow and Capacity" remain always visible
    });
  }

  // --- Checkmark for current selection ---
  function updateCheckmarks(lang) {
    items.forEach(function (item) {
      var check = item.querySelector('.lang-check');
      if (item.getAttribute('data-lang') === lang) {
        if (!check) {
          check = document.createElement('span');
          check.className = 'lang-check';
          check.setAttribute('aria-hidden', 'true');
          check.textContent = ' \u2713';
          item.appendChild(check);
        }
        item.setAttribute('aria-selected', 'true');
      } else {
        if (check) check.remove();
        item.removeAttribute('aria-selected');
      }
    });
  }

  // --- Dropdown open/close ---
  var isOpen = false;
  function openDropdown() {
    isOpen = true;
    dropdown.classList.add('lang-dropdown-open');
    btn.setAttribute('aria-expanded', 'true');
    var selected = dropdown.querySelector('[aria-selected="true"]');
    if (selected) selected.scrollIntoView({ block: 'nearest' });
  }
  function closeDropdown() {
    isOpen = false;
    dropdown.classList.remove('lang-dropdown-open');
    btn.setAttribute('aria-expanded', 'false');
  }

  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    if (isOpen) closeDropdown(); else openDropdown();
  });

  document.addEventListener('click', function () {
    if (isOpen) closeDropdown();
  });

  dropdown.addEventListener('click', function (e) {
    e.stopPropagation();
  });

  // --- Keyboard navigation ---
  btn.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openDropdown();
      var first = dropdown.querySelector('li[data-lang]');
      if (first) first.focus();
    }
    if (e.key === 'Escape') closeDropdown();
  });

  dropdown.addEventListener('keydown', function (e) {
    var focused = document.activeElement;
    var langItems = Array.prototype.slice.call(items);
    var idx = langItems.indexOf(focused);

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      var next = idx + 1 < langItems.length ? langItems[idx + 1] : langItems[0];
      next.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      var prev = idx - 1 >= 0 ? langItems[idx - 1] : langItems[langItems.length - 1];
      prev.focus();
    } else if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      if (focused && focused.getAttribute('data-lang')) {
        selectLang(focused.getAttribute('data-lang'));
      }
    } else if (e.key === 'Escape') {
      closeDropdown();
      btn.focus();
    }
  });

  // Make items focusable
  items.forEach(function (item) {
    item.setAttribute('tabindex', '-1');
  });

  // --- Language selection ---
  function selectLang(lang) {
    saveLang(lang);
    currentNameEl.textContent = LANG_NAMES[lang] || lang;
    updateCheckmarks(lang);
    updateNavVisibility(lang);
    closeDropdown();

    var targetUrl = computeTargetUrl(lang);
    if (targetUrl) {
      window.location.href = targetUrl;
    }
  }

  // Click handler on items
  items.forEach(function (item) {
    item.addEventListener('click', function () {
      selectLang(item.getAttribute('data-lang'));
    });
  });

  // --- Initialization ---
  function detectLangFromPage() {
    var page = classifyCurrentPage();
    if (FULL_SECTION_LANGS.indexOf(page.type) !== -1) return page.type;
    if (page.type === 'translation') return page.langCode;
    return null;
  }

  // Priority: page URL > localStorage > default 'en'
  var pageLang = detectLangFromPage();
  var savedLang = getSavedLang();
  var activeLang = pageLang || savedLang || 'en';

  // If page implies a language, update storage
  if (pageLang) saveLang(pageLang);

  currentNameEl.textContent = LANG_NAMES[activeLang] || activeLang;
  updateCheckmarks(activeLang);
  updateNavVisibility(activeLang);
});
</script>
